# 修改内容描述

阅读main分支最新代码，添加三master节点高可用集群部署模式支持。

在该模式下，用户node列表中需要配置三个master节点，其中有一个master节点为主master，worker节点数量不设限。
该模式下，需要在master节点上安装并配置haproxy和keepalived，安装资源已存在于embedded-resources目录。安装配置的顺序：

1.  配置内核参数环节，需要添加：
    
    ```bash
    cat <<'EOF' | sudo tee /etc/sysctl.d/99-k8s-lb.conf
    net.ipv4.ip_nonlocal_bind = 1
    EOF
    sudo sysctl --system
    ```
    
2. 安装好harproxy后，配置如下：
   
    注意要把里面 IP 改成配置的实际master地址
    
    ```bash
    sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak.$(date +%F)
    
    sudo tee /etc/haproxy/haproxy.cfg >/dev/null <<'EOF'
    global
      daemon
      maxconn 20000
    
    defaults
      mode tcp
      option tcplog
      timeout connect 5s
      timeout client  1m
      timeout server  1m
    
    # 对外入口：VIP:16443（避免与 apiserver 6443 冲突）
    frontend k8s_api
      bind *:16443
      mode tcp
      option tcplog
      default_backend k8s_api_backend
    
    # 后端：三台 apiserver 实际监听的 6443
    backend k8s_api_backend
      balance roundrobin
      option tcp-check
      default-server inter 2s fall 3 rise 2
      server cp1 10.0.0.11:6443 check
      server cp2 10.0.0.12:6443 check
      server cp3 10.0.0.13:6443 check
    EOF
    
    ```
    
    然后检查并启动：
    
    ```bash
    sudo haproxy -c -f /etc/haproxy/haproxy.cfg
    sudo systemctl enable --now haproxy
    ```
    
3. 安装好Keepalived后，配置如下：
    1. 准备检查脚本：haproxy 挂了就让出 VIP：
       
        ```bash
        sudo tee /etc/keepalived/check_haproxy.sh >/dev/null <<'EOF'
        #!/usr/bin/env bash
        set -euo pipefail
        systemctl is-active --quiet haproxy
        EOF
        sudo chmod a+x /etc/keepalived/check_haproxy.sh
        ```
        
    2. 配置 keepalived.conf
       
        注意：每个master节点在该配置文件中需要修改的点如下：
        
        1. router_id 需不同
        2. 主Master节点，state为MASTER，priority 应为 100，interface 应为该节点配置ip所在的网卡名称；unicast_src_ip 应为该节点所配置ip，`unicast_peer { 10.0.0.11 10.0.0.13 }` (填另外两台)。
        3. 其它Master节点 state 为 BACKUP，priority  应小于100，interface 应为其配置ip所在的网卡名称；unicast_src_ip 应为该节点所配置ip，`unicast_peer { 10.0.0.11 10.0.0.13 }` (填另外两台)。
        4. virtual_ipaddress  填配置时填写的vip地址
        
        ```bash
        sudo tee /etc/keepalived/keepalived.conf >/dev/null <<'EOF'
        global_defs {
          router_id K8S_CP_1
        }
        
        vrrp_script chk_haproxy {
          script "/etc/keepalived/check_haproxy.sh"
          interval 2
          fall 2
          rise 2
        }
        
        vrrp_instance VI_1 {
          state MASTER
          interface eth0
          virtual_router_id 51
          priority 100
          advert_int 1
        
          authentication {
            auth_type PASS
            auth_pass 123456
          }
        
          unicast_src_ip 10.0.0.11
          unicast_peer {
            10.0.0.12
            10.0.0.13
          }
        
          virtual_ipaddress {
            10.0.0.100/24
          }
        
          track_script {
            chk_haproxy
          }
        }
        EOF
        ```
        
        然后启动 keepalived：
        
        ```bash
        sudo systemctl enable --now keepalived
        ```
        

1. 初始化或加入集群环节
    1. kubeadm init命令要在原有基础上添加 `--control-plane-endpoint "vip:16443"` 和 `--upload-certs` 参数。kubeadm init命令只在优先级最高的那个主master上执行。
    2. 要生成“其它 master 加入”的命令，需要：
        1. 先生成/刷新证书 key：
           
            ```bash
            # 先生成/刷新证书 key,会输出一个 key
            kubeadm init phase upload-certs --upload-certs
            # 示例：
            [upload-certs] Using certificate key:
            b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6
            # 再打印 join 基础命令，然后拼上 control-plane 参数
            kubeadm token create --print-join-command
            # 那么 control-plane join 命令通常这样写（把两行拼起来）
            kubeadm join XXX --control-plane --certificate-key <刚才生成的Key>
            ```