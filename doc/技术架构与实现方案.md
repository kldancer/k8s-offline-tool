# K8s Offline Tool 技术架构与实现方案

## 1. 项目概述
`k8s-offline-tool` 是一个专门为内网、专网或网络隔离环境设计的 Kubernetes 自动化部署工具。它采用 Go 语言开发，通过 SSH 协议对远程服务器进行全自动化的离线安装配置。其核心价值在于将复杂的 K8s 环境准备、组件安装、插件部署等步骤抽象为标准化的 Pipeline，并提供生产级的可靠性与可视化反馈。

---

## 2. 总体技术架构
项目采用模块化设计，主要分为以下几个逻辑层：

### 2.1 通信层 (pkg/ssh)
*   **实现方式**：基于 `golang.org/x/crypto/ssh`。
*   **核心功能**：封装了命令执行（RunCommand）、交互式 Shell、SFTP 文件传输（集成 `github.com/pkg/sftp`）。
*   **特性**：支持带进度的文件传输监控，支持命令超时控制，作为所有远程操作的基础。

### 2.2 配置层 (pkg/config)
*   **功能**：负责 `config.yaml` 的解析与校验。
*   **模型**：定义了全局配置、节点定义、版本控制、插件开关及高可用参数。
*   **预定义元数据**：`images.yaml` 定义了离线环境下各组件所需的镜像列表。

### 2.3 策略层 (pkg/install/strategy)
*   **设计模式**：**策略模式 (Strategy Pattern)**。
*   **核心接口**：`NodeInstaller` 接口定义了各操作系统（Ubuntu, Fedora, OpenEuler）通用的安装动作（如禁用 Swap、安装 Containerd、配置内核参数等）。
*   **抽象实现**：`CommonOperations` 提供了跨发行版的共有逻辑，减少冗余代码。

### 2.4 引擎层 (pkg/runner)
*   **核心组件**：`Pipeline Runner`。
*   **逻辑**：将安装过程拆分为一系列 `Step`。每个 `Step` 包含 `Check` (幂等性检查) 和 `Action` (实际执行) 两部分。
*   **特性**：支持 `dryRun` 模式，确保步骤执行的原子性与幂等性。

### 2.5 交互层 (pkg/ui)
*   **实现方式**：基于 `github.com/vbauerster/mpb/v8` (Multi Progress Bar)。
*   **可视化**：为每个节点提供独立的动态进度条，实时显示当前步骤状态（检查中、执行中、资源分发进度）。
*   **对齐技术**：使用 `github.com/mattn/go-runewidth` 解决中文字符在终端下的对齐问题。

---

## 3. 核心功能实现方案

### 3.1 离线资源管理
*   **分发机制**：工具会将本地资源包（tar.gz）通过 SFTP 流式传输至远端 `/tmp`。
*   **增量校验**：通过计算本地与远端文件的 SHA256 哈希值进行匹配。如果远端已存在且哈希一致，则自动跳过上传，极大缩短二次安装时间。

### 3.2 自动化环境探测
*   **自适应安装**：通过远程执行探测脚本，识别目标机架构（amd64/arm64）、系统发行版、内核版本，甚至硬件加速卡（NVIDIA GPU/华为 Ascend NPU）。
*   **动态策略加载**：根据探测结果自动初始化对应的 `Installer` 实例。

### 3.3 高可用 (HA) 实现
*   **负载均衡**：自动在 Master 节点组上配置 `HAProxy` (作为 API Server 反向代理) 和 `Keepalived` (管理虚拟 IP/VIP)。
*   **配置生成**：根据节点列表动态生成 `haproxy.cfg` 和 `keepalived.conf`，并自动注入健康检查脚本。

### 3.4 插件与扩展 (Addons)
*   **Helm 集成**：内置 Helm 二进制安装及 Chart 部署逻辑。
*   **镜像重定向**：如果配置了私有仓库（Registry），工具会自动使用 `sed` 修改 Helm Chart 的 `values.yaml` 或 K8s Manifest，将镜像地址重定向到私有仓库。

---

## 4. 关键工作流程 (Workflow)
1.  **Init**：加载配置，初始化 SSH 连接池。
2.  **Probe**：并发执行环境探测，构建节点上下文。
3.  **Resource**：并发上传离线资源包并解压。
4.  **Preflight**：执行系统优化步骤（OS 调优）。
5.  **Runtime**：安装 Containerd、Docker、Runc 等容器运行时。
6.  **K8s Components**：安装 Kubeadm, Kubelet, Kubectl。
7.  **Bootstrap**：
    *   首台 Master 执行 `kubeadm init`。
    *   生成 Token 并同步给其他节点。
    *   Master 组/Worker 组执行 `kubeadm join`。
8.  **Addons**：部署 CNI (Kube-OVN/Multus)、监控 (Prometheus)、加速卡插件 (HAMi/Ascend Device Plugin)。
9.  **Report**：汇总每个节点的执行历史，生成结构化的详细报告。

---

## 5. 日志与报告系统
项目实现了双轨制日志系统：
*   **实时交互 (TUI)**：面向操作者，提供高频刷新的进度反馈，屏蔽冗余细节。
*   **详细报告 (Summary Log)**：
    *   **表格化对齐**：通过 `go-runewidth` 确保步骤名、状态、耗时在日志文件中完美对齐。
    *   **单行展示**：每个步骤仅占一行，便于通过 `grep` 或日志分析工具快速定位问题。
    *   **分段输出**：按节点分组，清晰记录每台服务器的完整“生命周期”记录。

---

## 6. 总结
`k8s-offline-tool` 通过策略模式解决了多发行版兼容性问题，通过 Pipeline 引擎确保了部署过程的稳健性，并利用 Golang 的并发特性实现了大规模节点的高效安装。其 TUI 与 格式化报告设计，使其具备了商业级运维工具的用户体验。
